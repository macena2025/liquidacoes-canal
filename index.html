<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel do Parceiro ‚Ä¢ Liquida√ß√µes</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --card:#0f1a31;
      --border:rgba(255,255,255,.08);
      --muted:rgba(255,255,255,.65);
      --text:rgba(255,255,255,.92);
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --accent:#16a34a;
      --accent2:#34d399;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(22,163,74,.22), transparent 55%),
                  radial-gradient(900px 500px at 100% 0%, rgba(52,211,153,.10), transparent 50%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
      line-height:1.35;
    }
    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height:100vh;
    }
    /* Sidebar */
    .sidebar{
      position:sticky;
      top:0;
      height:100vh;
      padding:18px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-right:1px solid var(--border);
      overflow:auto;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px 14px;
      margin-bottom:10px;
      border-bottom:1px solid var(--border);
    }
    .logo{
      width:38px;height:38px;
      border-radius:12px;
      background:
        radial-gradient(12px 12px at 35% 35%, rgba(255,255,255,.9), rgba(255,255,255,.0) 65%),
        radial-gradient(24px 24px at 70% 70%, rgba(52,211,153,.55), rgba(22,163,74,.0) 60%),
        linear-gradient(135deg, rgba(22,163,74,1), rgba(16,185,129,1));
      box-shadow: 0 10px 30px rgba(22,163,74,.25);
    }
    .brand h1{ font-size:14px; margin:0; letter-spacing:.2px; }
    .nav{ display:flex; flex-direction:column; gap:6px; padding:10px 6px; }
    .nav button{
      width:100%;
      border:1px solid transparent;
      background: transparent;
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      transition: .15s ease;
    }
    .nav button:hover{ background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.06); }
    .nav button.active{
      background: linear-gradient(180deg, rgba(22,163,74,.22), rgba(22,163,74,.08));
      border-color: rgba(34,197,94,.35);
      box-shadow: 0 10px 28px rgba(0,0,0,.18);
    }
    .nav .left{ display:flex; align-items:center; gap:10px; }
    .ico{
      width:32px; height:32px;
      border-radius:11px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
    }
    /* Main */
    .main{ padding:22px 22px 28px; }
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .title h2{ margin:0; font-size:20px; letter-spacing:.2px; }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:13px; max-width:70ch; }
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .control{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.07);
      box-shadow: 0 12px 28px rgba(0,0,0,.14);
    }
    .control label{ font-size:12px; color:var(--muted); }
    .control input, .control select{
      background: transparent;
      border:0; outline:none;
      color:var(--text);
      font-size:12px;
      min-width: 135px;
    }
    .btn{
      border:1px solid rgba(34,197,94,.35);
      background: linear-gradient(180deg, rgba(22,163,74,.35), rgba(22,163,74,.12));
      color:rgba(255,255,255,.95);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s ease;
      box-shadow: 0 16px 34px rgba(0,0,0,.16);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.ghost{ background: rgba(255,255,255,.03); border-color: rgba(255,255,255,.08); }
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:12px;
      margin-top:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.07);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .kpi{ padding:14px 14px 12px; position:relative; overflow:hidden; }
    .kpi .row{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .kpi h3{ margin:0; font-size:12px; color:var(--muted); font-weight:600; }
    .kpi .val{ margin:6px 0 0; font-size:22px; letter-spacing:.2px; font-weight:750; }
    .kpi .sub{ margin:6px 0 0; display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px; }
    .badge{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.09); background: rgba(255,255,255,.05); }
    .badge.good{ border-color: rgba(34,197,94,.35); color: rgba(167,243,208,.95); background: rgba(34,197,94,.12); }
    .badge.bad{ border-color: rgba(239,68,68,.35); color: rgba(254,202,202,.95); background: rgba(239,68,68,.10); }
    .badge.warn{ border-color: rgba(245,158,11,.35); color: rgba(253,230,138,.95); background: rgba(245,158,11,.10); }
    .section{ padding:14px; }
    .section h3{ margin:0; font-size:13px; color:rgba(255,255,255,.88); letter-spacing:.2px; }
    .section .meta{ margin:6px 0 0; color:var(--muted); font-size:12px; }
    .panel-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:10px; flex-wrap:wrap; }
    .panel-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      border:1px solid rgba(255,255,255,.09);
      background: rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color: rgba(255,255,255,.85);
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.12);
      color: rgba(167,243,208,.95);
    }
    .grid{ display:grid; grid-template-columns: 1fr 360px; gap:14px; align-items:start; margin-top:14px; }
    .chartWrap{ padding:10px 10px 6px; }
    svg.chart{
      width:100%;
      height:280px;
      display:block;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
    }
    .spreadCard{
      padding:16px;
      background:
        radial-gradient(600px 260px at 30% 0%, rgba(34,197,94,.30), transparent 55%),
        linear-gradient(180deg, rgba(22,163,74,.25), rgba(22,163,74,.08));
      border:1px solid rgba(34,197,94,.35);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .spreadCard .label{ color: rgba(255,255,255,.80); font-size:12px; }
    .spreadCard .value{ margin-top:10px; font-size:34px; font-weight:800; letter-spacing:.2px; }
    .spreadCard .hint{ margin-top:10px; color: rgba(255,255,255,.72); font-size:12px; line-height:1.45; }
    /* Table */
    .tableWrap{
      overflow:auto;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.07);
      background: rgba(255,255,255,.02);
    }
    table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 980px; }
    thead th{
      text-align:left;
      font-size:12px;
      color: rgba(255,255,255,.80);
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      position:sticky; top:0;
      background: rgba(15,23,42,.85);
      backdrop-filter: blur(8px);
      cursor:pointer; user-select:none; white-space:nowrap;
    }
    tbody td{ padding:12px 12px; font-size:12px; border-bottom:1px solid rgba(255,255,255,.06); color: rgba(255,255,255,.88); white-space:nowrap; }
    tbody tr:hover td{ background: rgba(255,255,255,.03); }
    .status{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size:11px;
      display:inline-flex; align-items:center; gap:6px;
    }
    .status .sDot{ width:8px;height:8px;border-radius:999px; background: rgba(255,255,255,.45); }
    .status.liquidado{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .status.liquidado .sDot{ background: var(--good); box-shadow: 0 0 0 3px rgba(34,197,94,.15); }
    .status.processando{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .status.processando .sDot{ background: var(--warn); box-shadow: 0 0 0 3px rgba(245,158,11,.14); }
    .status.divergencia{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.09); }
    .status.divergencia .sDot{ background: var(--bad); box-shadow: 0 0 0 3px rgba(239,68,68,.12); }
    .muted{ color: var(--muted) }
    .mono{ font-family: var(--mono) }
    .page{ display:none; }
    .page.active{ display:block; }
    .tooltip{
      position:fixed;
      pointer-events:none;
      transform: translate(10px, 10px);
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(15,23,42,.92);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      font-size:12px;
      color: rgba(255,255,255,.92);
      opacity:0;
      transition:.08s ease;
      min-width: 220px;
      backdrop-filter: blur(6px);
    }
    .tooltip b{ display:block; font-size:12px; margin-bottom:4px; }
    .tooltip .row{ display:flex; justify-content:space-between; gap:10px; color: var(--muted); }
    .tooltip .row span:last-child{ color: rgba(255,255,255,.9); }
    @media (max-width: 1100px){
      .app{ grid-template-columns: 88px 1fr; }
      .brand .txt{ display:none; }
      .nav button{ justify-content:center; }
      .nav .left span{ display:none; }
      .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .grid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 560px){
      .main{ padding:16px; }
      .kpis{ grid-template-columns: 1fr; }
      .control input, .control select{ min-width: 120px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="txt">
          <h1></h1>
        </div>
      </div>

      <nav class="nav" aria-label="Navega√ß√£o">
        <button class="active" data-page="dashboard">
          <div class="left">
            <div class="ico">üìä</div>
            <span>Dashboard</span>
          </div>
        </button>

        <button data-page="liquidacoes">
          <div class="left">
            <div class="ico">üí∏</div>
            <span>Liquida√ß√µes</span>
          </div>
        </button>

        <button data-page="relatorios">
          <div class="left">
            <div class="ico">üìÑ</div>
            <span>Relat√≥rios</span>
          </div>
        </button>
      </nav>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h2 id="pageTitle">Dashboard</h2>
          <p id="pageDesc">Vis√£o geral das liquida√ß√µes dos estabelecimentos cadastrados abaixo do seu canal.</p>
        </div>

        <div class="toolbar">
          <div class="control">
            <label for="from">De</label>
            <input id="from" type="date" />
          </div>
          <div class="control">
            <label for="to">At√©</label>
            <input id="to" type="date" />
          </div>
          <div class="control">
            <label for="bandeira">Bandeira</label>
            <select id="bandeira">
              <option value="ALL">Todas</option>
              <option value="Visa">Visa</option>
              <option value="Mastercard">Mastercard</option>
              <option value="Elo">Elo</option>
              <option value="Amex">Amex</option>
              <option value="Pix">Pix</option>
            </select>
          </div>
          <div class="control">
            <label for="tipo">Tipo</label>
            <select id="tipo">
              <option value="ALL">Todos</option>
              <option value="CREDITO">Cr√©dito</option>
              <option value="DEBITO">D√©bito</option>
              <option value="PARCELADO">Cr√©dito Parcelado</option>
              <option value="PIX">Pix</option>
            </select>
          </div>
          <button class="btn" id="apply">üîé Aplicar</button>
          <button class="btn ghost" id="reset">‚Ü©Ô∏é Reset</button>
        </div>
      </div>

      <!-- PAGE: DASHBOARD -->
      <section class="page active" id="page-dashboard">
        <div class="kpis">
          <div class="card kpi">
            <div class="row">
              <div>
                <h3>Total liquidado no per√≠odo</h3>
                <div class="val" id="kpiLiquidado">‚Äî</div>
                <div class="sub">
                  <span class="badge good" id="kpiLiquidadoDelta">‚Äî</span>
                  <span class="muted">vs per√≠odo anterior</span>
                </div>
              </div>
              <div class="ico" title="Liquida√ß√£o">üí∞</div>
            </div>
          </div>

          <div class="card kpi">
            <div class="row">
              <div>
                <h3>Estabelecimentos ativos</h3>
                <div class="val" id="kpiEstabs">‚Äî</div>
                <div class="sub">
                  <span class="badge" id="kpiInativos">‚Äî</span>
                  <span class="muted">inativos</span>
                </div>
              </div>
              <div class="ico" title="Lojas">üè™</div>
            </div>
          </div>

          <div class="card kpi">
            <div class="row">
              <div>
                <h3>Volume transacionado</h3>
                <div class="val" id="kpiVolume">‚Äî</div>
                <div class="sub">
                  <span class="badge warn" id="kpiTaxa">‚Äî</span>
                  <span class="muted">taxa m√©dia</span>
                </div>
              </div>
              <div class="ico" title="Volume">üí≥</div>
            </div>
          </div>

          <div class="card kpi">
            <div class="row">
              <div>
                <h3>Liquida√ß√£o m√©dia por loja</h3>
                <div class="val" id="kpiMedia">‚Äî</div>
                <div class="sub">
                  <span class="badge" id="kpiTicket">‚Äî</span>
                  <span class="muted">ticket m√©dio</span>
                </div>
              </div>
              <div class="ico" title="M√©dia">üìà</div>
            </div>
          </div>
        </div>

        <div class="grid">
          <div class="card section">
            <div class="panel-head">
              <div>
                <h3>Liquida√ß√£o di√°ria</h3>
                <div class="meta">Compara√ß√£o: per√≠odo atual vs per√≠odo anterior (mesma dura√ß√£o).</div>
              </div>
              <div class="panel-actions">
                <div class="chip active" data-series="liquidado">Liquida√ß√£o</div>
                <div class="chip" data-series="volume">Volume</div>
                <div class="chip" data-series="taxa">Taxa m√©dia</div>
              </div>
            </div>
            <div class="chartWrap">
              <svg class="chart" id="lineChart" viewBox="0 0 900 280" role="img" aria-label="Gr√°fico de linha"></svg>
            </div>
          </div>

          <div class="spreadCard">
            <div class="label">Receita total gerada pelo seu Spread (per√≠odo)</div>
            <div class="value mono" id="spreadTotal">‚Äî</div>
            <div class="hint">
              <b></b> 
           <span class="mono">spread</span> 
            </div>
          </div>
        </div>

        <div class="card section" style="margin-top:14px">
          <div class="panel-head">
            <div>
              <h3>Distribui√ß√£o por bandeira</h3>
              <div class="meta">Participa√ß√£o aproximada sobre o volume do per√≠odo selecionado .</div>
            </div>
            <div class="panel-actions">
              <button class="btn ghost" id="btnToggleBars">‚áÑ Alternar</button>
            </div>
          </div>
          <div class="chartWrap">
            <svg class="chart" id="barChart" viewBox="0 0 900 280" role="img" aria-label="Gr√°fico de barras"></svg>
          </div>
        </div>
      </section>

      <!-- PAGE: LIQUIDACOES -->
      <section class="page" id="page-liquidacoes">
        <div class="card section">
          <div class="panel-head">
            <div>
              <h3>Liquida√ß√µes por estabelecimento</h3>
              <div class="meta">Filtre por bandeira e tipo (Cr√©dito, D√©bito, Parcelado e Pix). </div>
            </div>
            <div class="panel-actions">
              <div class="control" style="padding:8px 10px;border-radius:12px">
                <label for="search">Busca</label>
                <input id="search" placeholder="Ex: Mercado, Farm√°cia..." />
              </div>
              <button class="btn" id="exportCsv">‚¨áÔ∏è Exportar CSV</button>
            </div>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th data-sort="estabelecimento">Estabelecimento</th>
                  <th data-sort="volume">Volume (Bruto)</th>
                  <th data-sort="taxa">Taxa m√©dia</th>
                  <th data-sort="liquido">Liquidado (L√≠quido)</th>
                  <th data-sort="spread">Spread</th>
                  <th data-sort="status">Status</th>
                  <th data-sort="crescimento">Crescimento</th>
                  <th data-sort="ultima">√öltima liquida√ß√£o</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:10px;font-size:12px" id="tableFooter">‚Äî</div>
        </div>
      </section>


      <div class="tooltip" id="tooltip"></div>
    </main>
  </div>

  <script>
    // ============================
    // 
    // ============================
    const fmtUSD = new Intl.NumberFormat("en-US", { style:"currency", currency:"USD" });
    const fmtNum = new Intl.NumberFormat("pt-BR");
    const today = new Date();

    const BRANDS = ["Visa","Mastercard","Elo","Amex","Pix"];
    const TYPES_BY_BRAND = {
      Visa:["CREDITO","DEBITO","PARCELADO"],
      Mastercard:["CREDITO","DEBITO","PARCELADO"],
      Elo:["CREDITO","DEBITO","PARCELADO"],
      Amex:["CREDITO","DEBITO","PARCELADO"],
      Pix:["PIX"]
    };

    const TYPE_LABEL = {
      ALL:"Todos",
      CREDITO:"Cr√©dito",
      DEBITO:"D√©bito",
      PARCELADO:"Cr√©dito Parcelado",
      PIX:"Pix"
    };

    const estabs = [
      { id:"E001", nome:"Mercado Bom Pre√ßo", cidade:"Recife", ativo:true },
      { id:"E002", nome:"Farm√°cia Central", cidade:"Sorocaba", ativo:true },
      { id:"E003", nome:"Bar do Julio (Bar Gay)", cidade:"Baixada Fluminense", ativo:true },
      { id:"E004", nome:"Auto Center Prime", cidade:"Fortaleza", ativo:true },
      { id:"E005", nome:"Loja Tech Express", cidade:"Orlando", ativo:true },
      { id:"E006", nome:"Padaria da Esquina", cidade:"Clermont", ativo:true },
      { id:"E007", nome:"Boutique Aurora", cidade:"Lake Buena Vista", ativo:true },
      { id:"E008", nome:"Pet Shop Feliz", cidade:"Orlando", ativo:true },
      { id:"E009", nome:"Caf√© & Companhia", cidade:"Orlando", ativo:false },
      { id:"E010", nome:"Mercadinho do Bairro", cidade:"Apopka", ativo:true },
      { id:"E011", nome:"Academia Movimento", cidade:"Orlando", ativo:true },
      { id:"E012", nome:"Studio Beauty Glow", cidade:"Orlando", ativo:true },
    ];

    function dateISO(d){ return d.toISOString().slice(0,10); }
    function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
    function rand(min, max){ return Math.random()*(max-min)+min; }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    // daily base series for charts
    const seriesDays = 120;
    const startSeries = addDays(today, -seriesDays+1);
    const daily = [];
    for(let i=0;i<seriesDays;i++){
      const d = addDays(startSeries,i);
      const weekFactor = [0.85, 0.92, 0.98, 1.02, 1.10, 1.18, 0.95][d.getDay()];
      const trend = 1 + (i/seriesDays)*0.12;
      const base = 52000 * weekFactor * trend;
      const volume = Math.max(12000, base + rand(-9000, 9000));
      const taxa = Math.max(0.018, Math.min(0.032, 0.024 + rand(-0.0045, 0.0045)));
      const liquido = volume * (1 - taxa) - rand(80, 420);
      daily.push({ date: dateISO(d), volume, taxa, liquido });
    }

    // weights per estab
    const weights = estabs.reduce((acc,e)=>{
      acc[e.id] = e.ativo ? rand(0.7, 1.4) : rand(0.05, 0.20);
      return acc;
    }, {});

    // ============================
    // State + bindings
    // ============================
    const els = {
      from: document.getElementById("from"),
      to: document.getElementById("to"),
      bandeira: document.getElementById("bandeira"),
      tipo: document.getElementById("tipo"),
      apply: document.getElementById("apply"),
      reset: document.getElementById("reset"),
      pageTitle: document.getElementById("pageTitle"),
      pageDesc: document.getElementById("pageDesc"),
      kpiLiquidado: document.getElementById("kpiLiquidado"),
      kpiLiquidadoDelta: document.getElementById("kpiLiquidadoDelta"),
      kpiEstabs: document.getElementById("kpiEstabs"),
      kpiInativos: document.getElementById("kpiInativos"),
      kpiVolume: document.getElementById("kpiVolume"),
      kpiTaxa: document.getElementById("kpiTaxa"),
      kpiMedia: document.getElementById("kpiMedia"),
      kpiTicket: document.getElementById("kpiTicket"),
      spreadTotal: document.getElementById("spreadTotal"),
      lineChart: document.getElementById("lineChart"),
      barChart: document.getElementById("barChart"),
      btnToggleBars: document.getElementById("btnToggleBars"),
      tbody: document.getElementById("tbody"),
      tableFooter: document.getElementById("tableFooter"),
      search: document.getElementById("search"),
      exportCsv: document.getElementById("exportCsv"),
      exportCsv2: document.getElementById("exportCsv2"),
      downloadJson: document.getElementById("downloadJson"),
      print: document.getElementById("print"),
      tooltip: document.getElementById("tooltip"),
      chips: Array.from(document.querySelectorAll(".chip")),
      navButtons: Array.from(document.querySelectorAll(".nav button")),
    };

    const pages = {
      dashboard: document.getElementById("page-dashboard"),
      liquidacoes: document.getElementById("page-liquidacoes"),
      relatorios: document.getElementById("page-relatorios"),
    };

    const pageMeta = {
      dashboard: { title:"Dashboard", desc:"Vis√£o geral das liquida√ß√µes dos estabelecimentos cadastrados abaixo do seu canal." },
      liquidacoes: { title:"Liquida√ß√µes", desc:"Tabela detalhada por estabelecimento, respeitando bandeira e tipo selecionados." },
      relatorios: { title:"Relat√≥rios", desc:"Exporta√ß√µes r√°pidas do que estiver filtrado." },
    };

    const state = {
      page: "dashboard",
      from: null,
      to: null,
      brand: "ALL",
      type: "ALL",
      rows: [],
      sortKey: "liquido",
      sortDir: "desc",
      chartSeries: "liquidado",
      barMode: "volume"
    };

    function setDefaultDates(){
      const to = new Date(today);
      const from = addDays(today, -30+1);
      els.from.value = dateISO(from);
      els.to.value = dateISO(to);
      state.from = els.from.value;
      state.to = els.to.value;
    }

    function formatDelta(x){
      const sign = x >= 0 ? "+" : "";
      return `${sign}${(x*100).toFixed(1)}%`;
    }
    function sum(arr, key){ return arr.reduce((acc, r)=>acc + (r[key]||0), 0); }

    // ============================
    // Brand/Type behavior (the thing you asked)
    // ============================
    function syncTipoOptions(){
      const brand = els.bandeira.value;
      const allowed = (brand === "ALL")
        ? ["ALL","CREDITO","DEBITO","PARCELADO","PIX"]
        : ["ALL", ...TYPES_BY_BRAND[brand]];

      // rebuild options
      const cur = els.tipo.value;
      els.tipo.innerHTML = "";
      allowed.forEach(v=>{
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = TYPE_LABEL[v] ?? v;
        els.tipo.appendChild(opt);
      });

      // keep selection if possible
      if(allowed.includes(cur)) els.tipo.value = cur;
      else els.tipo.value = "ALL";
    }

    els.bandeira.addEventListener("change", syncTipoOptions);

    // ============================
    // Build rows (mock aggregates)
    // ============================
    function getDailySlice(fromISO, toISO){
      const from = new Date(fromISO), to = new Date(toISO);
      return daily.filter(d=>{
        const x = new Date(d.date+"T00:00:00");
        return x >= from && x <= to;
      });
    }

    function buildSettlementRows(fromISO, toISO, brandFilter="ALL", typeFilter="ALL"){
      const from = new Date(fromISO);
      const to = new Date(toISO);
      const rows = [];

      for(const e of estabs){
        let vol = 0, liquido = 0, taxaAcc = 0, taxaCount = 0, lastDate = null;
        let spread = 0;
        let statusScore = 0;

        for(const day of daily){
          const d = new Date(day.date+"T00:00:00");
          if(d < from || d > to) continue;

          const w = weights[e.id];
          const estVolBase = day.volume * (w/estabs.length) * rand(0.85,1.15) * 6;

          // pick a brand and a type consistent with brand
          const brand = pick(BRANDS);
          const type = pick(TYPES_BY_BRAND[brand]);

          // filters
          if(brandFilter !== "ALL" && brand !== brandFilter) continue;
          if(typeFilter !== "ALL" && type !== typeFilter) continue;

          const estTaxa = Math.max(0.017, Math.min(0.038, day.taxa + rand(-0.004, 0.004)));
          const estLiq = estVolBase * (1 - estTaxa) - rand(5, 90);

          // MOCK spread (placeholder): in produ√ß√£o isso vem do seu back
          const estSpread = estVolBase * rand(0.0015, 0.0045);

          vol += estVolBase;
          liquido += estLiq;
          spread += estSpread;
          taxaAcc += estTaxa;
          taxaCount++;

          statusScore += rand(0,1) * (brand === "Pix" ? 0.2 : 0.6);
          if(!lastDate || d > new Date(lastDate)) lastDate = day.date;
        }

        if(vol <= 0) continue;

        const taxaMed = taxaCount ? (taxaAcc/taxaCount) : 0.024;
        const crescimento = rand(-0.22, 0.32) + (e.ativo ? rand(-0.03, 0.07) : rand(-0.25, -0.05));

        let status = "Liquidado";
        if(statusScore > 42) status = "Diverg√™ncia";
        else if(statusScore > 30) status = "Processando";

        rows.push({
          estabelecimento: `${e.nome} ‚Ä¢ ${e.cidade}`,
          estabId: e.id,
          volume: vol,
          liquido: liquido,
          spread: spread,
          taxa: taxaMed,
          status: status,
          crescimento: crescimento,
          ultima: lastDate || toISO,
          ativo: e.ativo
        });
      }

      return rows;
    }

    // ============================
    // Charts (SVG)
    // ============================
    function clearSVG(svg){ while(svg.firstChild) svg.removeChild(svg.firstChild); }
    function svgEl(tag, attrs={}){
      const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
      for(const k in attrs) el.setAttribute(k, attrs[k]);
      return el;
    }
    function drawGrid(svg, w, h, pad){
      const g = svgEl("g");
      const rows = 4, cols = 6;
      for(let i=0;i<=rows;i++){
        const y = pad + (h-2*pad)*(i/rows);
        g.appendChild(svgEl("line",{x1:pad,y1:y,x2:w-pad,y2:y, stroke:"rgba(255,255,255,.06)","stroke-width":"1"}));
      }
      for(let i=0;i<=cols;i++){
        const x = pad + (w-2*pad)*(i/cols);
        g.appendChild(svgEl("line",{x1:x,y1:pad,x2:x,y2:h-pad, stroke:"rgba(255,255,255,.04)","stroke-width":"1"}));
      }
      svg.appendChild(g);
    }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

    let currentChartData = { cur:[], prev:[], days:[] };

    function buildChartData(fromISO, toISO, seriesKey){
      const slice = getDailySlice(fromISO, toISO);
      const days = slice.map(d=>d.date);
      const len = days.length;

      const prevTo = addDays(new Date(fromISO), -1);
      const prevFrom = addDays(prevTo, -(len-1));
      const prevSlice = getDailySlice(dateISO(prevFrom), dateISO(prevTo));

      const keyMap = { liquidado:"liquido", volume:"volume", taxa:"taxa" };
      const k = keyMap[seriesKey] || "liquido";

      const cur = slice.map(d=>d[k]);
      const prev = prevSlice.map(d=>d[k]);
      while(prev.length < cur.length) prev.unshift(prev[0] ?? cur[0] ?? 0);

      currentChartData = { cur, prev, days };
      return currentChartData;
    }

    function niceNumber(v){
      if(state.chartSeries === "taxa") return (v*100).toFixed(2) + "%";
      return fmtUSD.format(v);
    }

    function showTooltipFromPoint(px, py, label, cur, prev){
      const x = clamp(px+14, 10, window.innerWidth-260);
      const y = clamp(py+14, 10, window.innerHeight-120);
      els.tooltip.style.left = x + "px";
      els.tooltip.style.top = y + "px";
      const valCur = (state.chartSeries === "taxa") ? (cur*100).toFixed(2)+"%" : fmtUSD.format(cur);
      const valPrev = (state.chartSeries === "taxa") ? (prev*100).toFixed(2)+"%" : fmtUSD.format(prev);
      els.tooltip.innerHTML = `
        <b>${label}</b>
        <div class="row"><span>Atual</span><span>${valCur}</span></div>
        <div class="row"><span>Anterior</span><span>${valPrev}</span></div>
      `;
      els.tooltip.style.opacity = 1;
    }
    function hideTooltip(){ els.tooltip.style.opacity = 0; }

    function drawLineChart(svg, seriesA, seriesB, labels){
      clearSVG(svg);
      const vb = svg.viewBox.baseVal;
      const w = vb.width, h = vb.height;
      const pad = 36;
      drawGrid(svg,w,h,pad);

      const all = seriesA.concat(seriesB);
      const min = Math.min(...all);
      const max = Math.max(...all);
      const rng = (max-min) || 1;

      const x = (i)=> pad + (w-2*pad)*(i/(seriesA.length-1 || 1));
      const y = (v)=> pad + (h-2*pad)*(1 - ((v-min)/rng));

      function pathFrom(series){
        let d = "";
        series.forEach((v,i)=>{ d += (i===0? "M":"L") + x(i).toFixed(2) + " " + y(v).toFixed(2) + " "; });
        return d.trim();
      }

      const defs = svgEl("defs");
      const grad = svgEl("linearGradient",{id:"gA",x1:"0",y1:"0",x2:"0",y2:"1"});
      grad.appendChild(svgEl("stop",{offset:"0%","stop-color":"rgba(34,197,94,.28)"}));
      grad.appendChild(svgEl("stop",{offset:"100%","stop-color":"rgba(34,197,94,.02)"}));
      defs.appendChild(grad);

      const grad2 = svgEl("linearGradient",{id:"gB",x1:"0",y1:"0",x2:"0",y2:"1"});
      grad2.appendChild(svgEl("stop",{offset:"0%","stop-color":"rgba(148,163,184,.20)"}));
      grad2.appendChild(svgEl("stop",{offset:"100%","stop-color":"rgba(148,163,184,.02)"}));
      defs.appendChild(grad2);
      svg.appendChild(defs);

      const dA = pathFrom(seriesA);
      const areaA = dA + ` L ${x(seriesA.length-1)} ${h-pad} L ${x(0)} ${h-pad} Z`;
      svg.appendChild(svgEl("path",{d:areaA, fill:"url(#gA)"}));

      const dB = pathFrom(seriesB);
      const areaB = dB + ` L ${x(seriesB.length-1)} ${h-pad} L ${x(0)} ${h-pad} Z`;
      svg.appendChild(svgEl("path",{d:areaB, fill:"url(#gB)"}));

      svg.appendChild(svgEl("path",{d:dB, fill:"none", stroke:"rgba(148,163,184,.85)","stroke-width":"2.2"}));
      svg.appendChild(svgEl("path",{d:dA, fill:"none", stroke:"rgba(34,197,94,.95)","stroke-width":"2.6"}));

      const hitG = svgEl("g");
      seriesA.forEach((v,i)=>{
        const cx = x(i), cy = y(v);
        const hit = svgEl("circle",{cx, cy, r:"12", fill:"transparent"});
        const label = labels[i] || "";
        hit.addEventListener("mouseenter", (e)=> showTooltipFromPoint(e.clientX, e.clientY, label, seriesA[i], seriesB[i]));
        hit.addEventListener("mousemove", (e)=> showTooltipFromPoint(e.clientX, e.clientY, label, seriesA[i], seriesB[i]));
        hit.addEventListener("mouseleave", hideTooltip);
        hitG.appendChild(hit);
      });
      svg.appendChild(hitG);

      const t1 = svgEl("text",{x:pad, y:pad-10, fill:"rgba(255,255,255,.65)", "font-size":"11"});
      t1.textContent = niceNumber(max);
      const t2 = svgEl("text",{x:pad, y:h-pad+22, fill:"rgba(255,255,255,.65)", "font-size":"11"});
      t2.textContent = niceNumber(min);
      svg.appendChild(t1); svg.appendChild(t2);
    }

    function drawBarChart(svg, data){
      clearSVG(svg);
      const vb = svg.viewBox.baseVal;
      const w = vb.width, h = vb.height;
      const pad = 46;
      drawGrid(svg,w,h,pad);

      const labels = data.map(d=>d.label);
      const vals = data.map(d=>d.value);
      const max = Math.max(...vals, 1);
      const barW = (w-2*pad) / (labels.length*1.35);
      const gap = barW*0.35;

      data.forEach((d,i)=>{
        const x = pad + i*(barW+gap);
        const bh = (h-2*pad) * (d.value/max);
        const y = h-pad - bh;

        const rect = svgEl("rect",{ x, y, width:barW, height:bh, rx:"12", ry:"12",
          fill:"rgba(34,197,94,.55)", stroke:"rgba(34,197,94,.25)", "stroke-width":"1" });
        rect.addEventListener("mouseenter", (e)=>{
          const val = state.barMode === "share" ? (d.value*100).toFixed(1)+"%" : fmtUSD.format(d.value);
          els.tooltip.style.opacity = 1;
          els.tooltip.innerHTML = `<b>${d.label}</b><div class="row"><span>${state.barMode === "share" ? "Participa√ß√£o" : "Volume"}</span><span>${val}</span></div>`;
          els.tooltip.style.left = clamp(e.clientX+14, 10, window.innerWidth-260)+"px";
          els.tooltip.style.top = clamp(e.clientY+14, 10, window.innerHeight-120)+"px";
        });
        rect.addEventListener("mousemove", (e)=>{
          els.tooltip.style.left = clamp(e.clientX+14, 10, window.innerWidth-260)+"px";
          els.tooltip.style.top = clamp(e.clientY+14, 10, window.innerHeight-120)+"px";
        });
        rect.addEventListener("mouseleave", hideTooltip);
        svg.appendChild(rect);

        const tx = svgEl("text",{x:x+barW/2, y:h-pad+22, fill:"rgba(255,255,255,.72)","font-size":"11","text-anchor":"middle"});
        tx.textContent = d.label;
        svg.appendChild(tx);
      });
    }

    // ============================
    // Rendering
    // ============================
    function renderKpis(rows){
      const liquidado = sum(rows,"liquido");
      const volume = sum(rows,"volume");
      const spread = sum(rows,"spread");
      const taxaMed = rows.length ? sum(rows,"taxa")/rows.length : 0;
      const ativos = estabs.filter(e=>e.ativo).length;
      const inativos = estabs.filter(e=>!e.ativo).length;
      const mediaLoja = ativos ? liquidado/ativos : 0;
      const ticketMed = rows.length ? volume/rows.length : 0;

      const chart = buildChartData(state.from, state.to, "liquidado");
      const curTot = chart.cur.reduce((a,b)=>a+b,0);
      const prevTot = chart.prev.reduce((a,b)=>a+b,0);
      const delta = prevTot ? (curTot-prevTot)/prevTot : 0;

      els.kpiLiquidado.textContent = fmtUSD.format(liquidado);
      els.kpiVolume.textContent = fmtUSD.format(volume);
      els.kpiTaxa.textContent = (taxaMed*100).toFixed(2) + "%";
      els.kpiEstabs.textContent = fmtNum.format(ativos);
      els.kpiInativos.textContent = fmtNum.format(inativos);
      els.kpiMedia.textContent = fmtUSD.format(mediaLoja);
      els.kpiTicket.textContent = fmtUSD.format(ticketMed);
      els.spreadTotal.textContent = fmtUSD.format(spread);

      const b = els.kpiLiquidadoDelta;
      b.textContent = formatDelta(delta);
      b.classList.remove("good","bad","warn");
      if(delta >= 0.03) b.classList.add("good");
      else if(delta <= -0.03) b.classList.add("bad");
      else b.classList.add("warn");
    }

    function renderLineChart(){
      const chart = buildChartData(state.from, state.to, state.chartSeries);
      const labels = chart.days.map(iso=>{
        const d = new Date(iso+"T00:00:00");
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        return `${dd}/${mm}`;
      });
      drawLineChart(els.lineChart, chart.cur, chart.prev, labels);
    }

    function renderBarChart(rows){
      const base = {"Visa":0.28,"Mastercard":0.30,"Elo":0.18,"Amex":0.06,"Pix":0.18};
      const totalVol = sum(rows,"volume") || 1;
      const data = BRANDS.map(b=>{
        let v = totalVol * base[b] * rand(0.9,1.1);
        return { label:b, value:v };
      });
      if(state.barMode === "share"){
        const s = data.reduce((a,b)=>a+b.value,0) || 1;
        data.forEach(d=> d.value = d.value/s);
      }
      drawBarChart(els.barChart, data);
    }

    function sortRows(rows){
      const key = state.sortKey;
      const dir = state.sortDir === "asc" ? 1 : -1;
      const copy = [...rows];
      copy.sort((a,b)=>{
        let av = a[key], bv = b[key];
        if(key === "status"){ av = a.status; bv = b.status; }
        if(typeof av === "string") return av.localeCompare(bv,"pt-BR") * dir;
        return (av - bv) * dir;
      });
      return copy;
    }

    function renderTable(){
      let rows = [...state.rows];
      const q = (els.search?.value || "").trim().toLowerCase();
      if(q){
        rows = rows.filter(r=> r.estabelecimento.toLowerCase().includes(q) || r.estabId.toLowerCase().includes(q));
      }
      rows = sortRows(rows);

      els.tbody.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        const statusClass = r.status === "Liquidado" ? "liquidado" : (r.status === "Processando" ? "processando" : "divergencia");
        const growBadge = r.crescimento >= 0 ? "good" : "bad";
        tr.innerHTML = `
          <td>
            <div style="display:flex;flex-direction:column;gap:3px">
              <span><b>${r.estabelecimento}</b></span>
              <span class="muted mono">${r.estabId} ‚Ä¢ ${r.ativo ? "Ativo" : "Inativo"}</span>
            </div>
          </td>
          <td class="mono">${fmtUSD.format(r.volume)}</td>
          <td class="mono">${(r.taxa*100).toFixed(2)}%</td>
          <td class="mono"><b>${fmtUSD.format(r.liquido)}</b></td>
          <td class="mono"><b>${fmtUSD.format(r.spread)}</b></td>
          <td><span class="status ${statusClass}"><span class="sDot"></span>${r.status}</span></td>
          <td><span class="badge ${growBadge}">${formatDelta(r.crescimento)}</span></td>
          <td class="mono">${r.ultima}</td>
        `;
        els.tbody.appendChild(tr);
      });

      els.tableFooter.textContent = `${rows.length} registros exibidos ‚Ä¢ Bandeira: ${state.brand} ‚Ä¢ Tipo: ${TYPE_LABEL[state.type] ?? state.type}`;
    }

    function computeRows(){
      state.rows = buildSettlementRows(state.from, state.to, state.brand, state.type);
    }

    function renderAll(){
      computeRows();
      renderKpis(state.rows);
      renderLineChart();
      renderBarChart(state.rows);
      renderTable();
    }

    // ============================
    // Navigation (THIS is what was broken before)
    // ============================
    function go(page){
      state.page = page;
      els.navButtons.forEach(b=> b.classList.toggle("active", b.dataset.page === page));
      Object.entries(pages).forEach(([k,el])=> el.classList.toggle("active", k===page));
      els.pageTitle.textContent = pageMeta[page].title;
      els.pageDesc.textContent = pageMeta[page].desc;
      hideTooltip();
    }
    els.navButtons.forEach(btn=> btn.addEventListener("click", ()=> go(btn.dataset.page)));

    // Sorting
    document.querySelectorAll("thead th").forEach(th=>{
      th.addEventListener("click", ()=>{
        const key = th.dataset.sort;
        if(!key) return;
        if(state.sortKey === key) state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
        else { state.sortKey = key; state.sortDir = (key === "estabelecimento" || key === "status") ? "asc" : "desc"; }
        renderTable();
      });
    });

    // Chips
    els.chips.forEach(ch=>{
      ch.addEventListener("click", ()=>{
        els.chips.forEach(x=>x.classList.remove("active"));
        ch.classList.add("active");
        state.chartSeries = ch.dataset.series;
        renderLineChart();
      });
    });

    els.btnToggleBars.addEventListener("click", ()=>{
      state.barMode = state.barMode === "volume" ? "share" : "volume";
      renderBarChart(state.rows);
    });

    // Search
    els.search.addEventListener("input", ()=> renderTable());

    // Apply/Reset
    els.apply.addEventListener("click", ()=>{
      state.from = els.from.value;
      state.to = els.to.value;
      state.brand = els.bandeira.value;
      state.type = els.tipo.value;
      renderAll();
    });

    els.reset.addEventListener("click", ()=>{
      setDefaultDates();
      els.bandeira.value = "ALL";
      els.tipo.value = "ALL";
      syncTipoOptions();
      state.brand = "ALL";
      state.type = "ALL";
      els.search.value = "";
      state.sortKey = "liquido";
      state.sortDir = "desc";
      state.chartSeries = "liquidado";
      els.chips.forEach(x=>x.classList.toggle("active", x.dataset.series==="liquidado"));
      state.barMode = "volume";
      renderAll();
    });

    // Exports
    function download(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 800);
    }

    function rowsToCSV(rows){
      const header = ["estabId","estabelecimento","volume","taxa","liquido","spread","status","crescimento","ultima","ativo","bandeira_filtro","tipo_filtro"];
      const lines = [header.join(",")];
      rows.forEach(r=>{
        const line = [
          r.estabId,
          `"${r.estabelecimento.replace(/"/g,'""')}"`,
          r.volume.toFixed(2),
          (r.taxa*100).toFixed(2),
          r.liquido.toFixed(2),
          r.spread.toFixed(2),
          r.status,
          (r.crescimento*100).toFixed(2),
          r.ultima,
          r.ativo,
          state.brand,
          state.type
        ].join(",");
        lines.push(line);
      });
      return lines.join("\n");
    }

    function exportCSV(){
      let rows = [...state.rows];
      const q = (els.search.value || "").trim().toLowerCase();
      if(q) rows = rows.filter(r=> r.estabelecimento.toLowerCase().includes(q) || r.estabId.toLowerCase().includes(q));
      rows = sortRows(rows);
      download(`liquidacoes_${state.from}_a_${state.to}.csv`, rowsToCSV(rows));
    }
    els.exportCsv.addEventListener("click", exportCSV);
    els.exportCsv2.addEventListener("click", exportCSV);

    els.downloadJson.addEventListener("click", ()=>{
      const payload = {
        filtro: { from: state.from, to: state.to, bandeira: state.brand, tipo: state.type },
        totals: {
          totalLiquidado: sum(state.rows,"liquido"),
          totalVolume: sum(state.rows,"volume"),
          totalSpread: sum(state.rows,"spread"),
        },
        rows: state.rows
      };
      download(`dados_${state.from}_a_${state.to}.json`, JSON.stringify(payload,null,2));
    });

    els.print.addEventListener("click", ()=> window.print());

    // Init
    setDefaultDates();
    syncTipoOptions();
    state.brand = els.bandeira.value;
    state.type = els.tipo.value;
    renderAll();
  </script>
</body>
</html>
